<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="è´ªåƒè›‡å¤§ä½œæˆ˜ - æ¸¸æˆä¸»é¡µé¢">
    <title>è´ªåƒè›‡å¤§ä½œæˆ˜ - æ¸¸æˆ</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- åŠ¨æ€èƒŒæ™¯çƒä½“ -->
    <div class="background-orbs">
        <div class="orb orb-cyan"></div>
        <div class="orb orb-fuchsia"></div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="main-container">
        <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
        <div class="top-bar">
            <div class="user-info">
                æ¬¢è¿, <strong id="username-display">ç©å®¶</strong>!
                <span class="text-muted">|</span>
                æœ€é«˜åˆ†: <span id="high-score">0</span>
            </div>
            <div class="score-display">
                å½“å‰åˆ†æ•°: <span id="current-score">0</span>
            </div>
            <button class="btn btn-secondary" onclick="handleLogout()">é€€å‡ºç™»å½•</button>
        </div>

        <!-- æ¸¸æˆç”»å¸ƒ -->
        <div class="game-canvas-wrapper">
            <canvas id="game-canvas" class="game-canvas" width="400" height="400"></canvas>
        </div>

        <!-- æ¸¸æˆæ§åˆ¶æŒ‰é’® -->
        <div class="game-controls">
            <button class="btn btn-primary" id="btn-start" onclick="startGame()">
                â–¶ å¼€å§‹æ¸¸æˆ
            </button>
            <button class="btn btn-secondary" id="btn-pause" onclick="togglePause()" disabled>
                â¸ æš‚åœ
            </button>
            <button class="btn btn-fuchsia" onclick="window.location.href='history.html'">
                ğŸ“Š å†å²è®°å½•
            </button>
        </div>

        <!-- æ“ä½œæç¤º -->
        <p class="text-center mt-4" style="color: var(--text-muted); font-size: 0.9rem;">
            ä½¿ç”¨ <strong>æ–¹å‘é”®</strong> æˆ– <strong>WASD</strong> æ§åˆ¶æ–¹å‘ï¼Œ<strong>ç©ºæ ¼é”®</strong> æš‚åœ
        </p>
    </div>

    <!-- æ¸¸æˆç»“æŸå¼¹çª— -->
    <div class="modal-overlay" id="game-over-modal">
        <div class="glass-card modal-content">
            <h2 class="modal-title gradient-title gradient-title-sm">æ¸¸æˆç»“æŸ!</h2>
            <p class="modal-score">æœ€ç»ˆå¾—åˆ†: <span id="final-score">0</span></p>
            <p style="color: var(--text-muted); margin-bottom: 24px;">æ¸¸æˆæ—¶é•¿: <span id="game-duration">0</span> ç§’</p>
            <div class="btn-group" style="justify-content: center;">
                <button class="btn btn-primary" onclick="restartGame()">ğŸ”„ å†æ¥ä¸€å±€</button>
                <button class="btn btn-secondary" onclick="closeModal()">è¿”å›</button>
            </div>
        </div>
    </div>

    <script src="js/storage.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/game.js"></script>
    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!Auth.requireLogin()) {
            // å¦‚æœæœªç™»å½•ï¼ŒrequireLogin ä¼šè‡ªåŠ¨è·³è½¬
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        let game = null;

        document.addEventListener('DOMContentLoaded', () => {
            // æ˜¾ç¤ºç”¨æˆ·å
            const username = Auth.getCurrentUsername();
            document.getElementById('username-display').textContent = username;

            // æ˜¾ç¤ºæœ€é«˜åˆ†
            const highScore = Storage.getUserHighScore(username);
            document.getElementById('high-score').textContent = highScore;

            // åˆ›å»ºæ¸¸æˆå®ä¾‹
            game = new SnakeGame('game-canvas');

            // è®¾ç½®å›è°ƒ
            game.onScoreChange = (score) => {
                document.getElementById('current-score').textContent = score;
            };

            game.onGameOver = (score, duration) => {
                showGameOverModal(score, duration);
                // æ›´æ–°æœ€é«˜åˆ†æ˜¾ç¤º
                const highScore = Storage.getUserHighScore(username);
                document.getElementById('high-score').textContent = highScore;
            };

            // åˆå§‹åŒ–æ¸¸æˆ
            game.init();
        });

        /**
         * å¼€å§‹æ¸¸æˆ
         */
        function startGame() {
            if (!game) return;

            game.init();
            game.start();

            document.getElementById('btn-start').disabled = true;
            document.getElementById('btn-start').textContent = 'æ¸¸æˆä¸­...';
            document.getElementById('btn-pause').disabled = false;
        }

        /**
         * æš‚åœ/ç»§ç»­æ¸¸æˆ
         */
        function togglePause() {
            if (!game) return;

            game.togglePause();

            const btnPause = document.getElementById('btn-pause');
            if (game.isPaused) {
                btnPause.textContent = 'â–¶ ç»§ç»­';
            } else {
                btnPause.textContent = 'â¸ æš‚åœ';
            }
        }

        /**
         * æ˜¾ç¤ºæ¸¸æˆç»“æŸå¼¹çª—
         */
        function showGameOverModal(score, duration) {
            document.getElementById('final-score').textContent = score;
            document.getElementById('game-duration').textContent = duration;
            document.getElementById('game-over-modal').classList.add('active');

            // é‡ç½®æŒ‰é’®çŠ¶æ€
            document.getElementById('btn-start').disabled = false;
            document.getElementById('btn-start').textContent = 'â–¶ å¼€å§‹æ¸¸æˆ';
            document.getElementById('btn-pause').disabled = true;
            document.getElementById('btn-pause').textContent = 'â¸ æš‚åœ';
        }

        /**
         * å…³é—­å¼¹çª—
         */
        function closeModal() {
            document.getElementById('game-over-modal').classList.remove('active');
        }

        /**
         * é‡æ–°å¼€å§‹æ¸¸æˆ
         */
        function restartGame() {
            closeModal();
            startGame();
        }

        /**
         * é€€å‡ºç™»å½•
         */
        function handleLogout() {
            Auth.logout();
            window.location.href = 'index.html';
        }
    </script>
</body>

</html>
